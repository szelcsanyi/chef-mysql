#!/bin/bash

###
# Generated by Chef for [<%= node[:fqdn] %>]
# Environment: <%= node.chef_environment %>
###

set -o pipefail

ulimit -n 16000

declare RET=1
declare MYSQL="<%= @base %>/current/bin/mysql -S <%= @base %>/var/mysqld.sock"
declare SSH="/usr/bin/ssh -q -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -i <%= @base %>/tools/backup_rsa -l <%= @backup_user %> -p <%= @backup_port %> <%= @backup_host %>"

function finish {
  if [ "$RET" -ne 0 ]; then
    /bin/touch /tmp/mysql-backup-<%= @port %>-failed
  else
    /bin/rm -f /tmp/mysql-backup-<%= @port %>-failed
  fi
}
trap finish EXIT

declare READONLY=0
declare ISMASTER=0

READONLY=$($MYSQL -N -e "select @@read_only" -u root)
ISMASTER=$($MYSQL -N -e "show slave hosts" -uroot | /usr/bin/wc -l)

if [ "<%= @backup_force %>" == "false" ] && [ "$READONLY" == "0" ] && [ "$ISMASTER" != "0" ] ; then
  echo "$(date) Not passive master! Exiting."
  RET=0
  exit 0
fi

echo "$(date) Starting mysql backup"

# create destination directory.
if ! $SSH "mkdir -p <%= @backup_path %>/$(hostname -f)"; then
  echo "$(date) Cannot create remote directory!"
  exit 1
fi

# do the extrabackup
declare PASSWORD=""
if [ -f "/root/.my.cnf" ]; then
  PASSWORD="--password="$(sed -nr 's/password\ ?=\ ?(.+)/\1/p' /root/.my.cnf)
fi

declare BACKUP_FILE=""
BACKUP_FILE="$(hostname -f)/$(hostname -f).$(date +%Y%m%d-%H%M%S).xtrabackup.tar.gz"
if [ -x "/usr/bin/innobackupex" ]; then
  if ! /usr/bin/innobackupex --defaults-file=<%= @base %>/etc/my.cnf --use-memory=1G --safe-slave-backup --slave-info --tmpdir=<%= @base %>/tmp --user=root $PASSWORD --defaults-group=server --stream=tar ./ | pigz -9 -p <%= (node["cpu"]["total"]/2.to_f).ceil %> | $SSH "cat - > <%= @backup_path %>/$BACKUP_FILE.inprogress"; then
    echo "$(date) Backup failed!"
    exit 1
  fi

  if ! $SSH "mv <%= @backup_path %>/$BACKUP_FILE.inprogress <%= @backup_path %>/$BACKUP_FILE"; then
    echo "$(date) Cannot rename inprogress file!"
    exit 1
  fi
else
  echo "$(date) innobackupex not found!"
  exit 1
fi

# update backup index
if ! $SSH "echo $BACKUP_FILE >> <%= @backup_path %>/<%= @name %>.index"; then
  echo "$(date) Backup index update failed!"
  exit 1
fi

RET=0
echo "$(date) Finished mysql backup"
