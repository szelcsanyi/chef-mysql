#!/bin/bash

###
# Generated by Chef for [<%= node[:fqdn] %>]
# Environment: <%= node.chef_environment %>
###

BINLOGDIR=<%= @binlog_dir %>
MYSQLCLI=<%= @mysql_cli %>
MYSQLSOCKET=<%= @mysql_socket %>

KEEP_NR_OF_FILES=`find $BINLOGDIR -type f -name 'mysql-bin.[0-9]*' -cmin -<%= @binlogcleaner_keep_minutes %> | wc -l`

if [[ "$KEEP_NR_OF_FILES" -eq 0 ]]; then
  KEEP_NR_OF_FILES=1
fi

while [[ `df -P $BINLOGDIR | tail -n1 | awk '{print $5}' | cut -d '%' -f 1` -gt 85 ]]; do
  if [[ `$MYSQLCLI -S $MYSQLSOCKET -ss -e "show master logs" | wc -l` -gt KEEP_NR_OF_FILES ]]; then
    FILE=`mysql -S $MYSQLSOCKET -ss -e "SHOW MASTER LOGS" | head -n2 | tail -n1 | awk '{ print $1 }'`;
    $MYSQLCLI -S $MYSQLSOCKET -e "PURGE MASTER LOGS TO '$FILE'"
  else
    echo "Something went wrong. Cannot delete enough binlogs!";
    exit 1;
  fi
  sleep 5;
done
