#!/bin/bash

###
# Generated by Chef for [<%= node[:fqdn] %>]
# Environment: <%= node.chef_environment %>
###

declare MYSQL="<%= @base %>/current/bin/mysql -S <%= @base %>/var/mysqld.sock"
declare SSH="/usr/bin/ssh -q -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -c arcfour -i <%= @base %>/tools/backup_rsa -l <%= @backup_user %> -p <%= @backup_port %>"

declare READONLY=0
declare ISMASTER=0
declare HAVEBINLOG=0

READONLY=$($MYSQL -N -e "select @@read_only" -u root)
ISMASTER=$($MYSQL -N -e "show slave hosts" -uroot | /usr/bin/wc -l)
HAVEBINLOG=$($MYSQL -N -e "select @@log_bin" -uroot)

if [ "<%= @backup_force %>" == "false" ] && [ "$READONLY" == "0" ] && [ "$ISMASTER" != "0" ] ; then
  echo "$(data) Not passive master!"
  exit 0
fi

if [ "$HAVEBINLOG" == "0" ]; then
  echo "$(date) Have no binlog!"
  exit 0
fi

echo "$(date) Starting binlog backup"

# create destination directory.
$SSH <%= @backup_host %> "mkdir -p <%= @backup_path %>/$(hostname -f)/binlog"

# backup binlog files
/usr/bin/rsync -aq --inplace --append -e "$SSH" <%= @base %>/binlog/ <%= @backup_host %>:<%= @backup_path %>/"$(hostname -f)"/binlog

echo "$(date) Finished binlog backup"
