#!/bin/bash

###
# Generated by Chef for [<%= node[:fqdn] %>]
# Environment: <%= node.chef_environment %>
###

# monitoring script for mysql for <%= @name %>
#  creates status files in /tmp
#   - show status
#   - show slave status

# monitoring user needs to be created with base privilages:
# GRANT PROCESS, REPLICATION CLIENT ON *.* TO 'db_monitor'@'127.0.0.1' IDENTIFIED BY PASSWORD '*8248778E2BE81112DA61ADD724057530A4BE7275' WITH MAX_USER_CONNECTIONS 5;

MCLI="<%= @basedir %>/current/bin/mysql --no-defaults -u db_monitor -pdb_monitor -h 127.0.0.1 -P <%= @port %>"
MSTATUS="/tmp/mysql-monitoring-status-<%= @port %>"

# status
if timeout 3 $MCLI -e "show global status; show global variables; show slave status\G" > $MSTATUS.tmp ; then sleep 1; mv $MSTATUS.tmp $MSTATUS; else rm $MSTATUS.tmp; rm $MSTATUS; fi
